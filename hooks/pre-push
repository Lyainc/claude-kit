#!/usr/bin/env bash
# Pre-push hook to prevent pushing when local branch has diverged from remote
# This helps prevent conflicts in multi-agent workflows

set -euo pipefail

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

MAIN_BRANCH="main"
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Only check when pushing to main branch
if [ "$CURRENT_BRANCH" = "$MAIN_BRANCH" ]; then
    # Fetch remote silently
    git fetch origin "$MAIN_BRANCH" --quiet 2>/dev/null || true

    LOCAL=$(git rev-parse "$MAIN_BRANCH" 2>/dev/null || echo "")
    REMOTE=$(git rev-parse "origin/$MAIN_BRANCH" 2>/dev/null || echo "")

    if [ -n "$LOCAL" ] && [ -n "$REMOTE" ] && [ "$LOCAL" != "$REMOTE" ]; then
        MERGE_BASE=$(git merge-base "$MAIN_BRANCH" "origin/$MAIN_BRANCH" 2>/dev/null || echo "")

        # Check if we can fast-forward
        if [ "$MERGE_BASE" = "$LOCAL" ]; then
            echo -e "${YELLOW}Warning: Local main is behind remote.${NC}"
            echo -e "${YELLOW}Run: git pull origin $MAIN_BRANCH${NC}"
            exit 1
        elif [ "$MERGE_BASE" != "$REMOTE" ]; then
            # Branches have diverged
            echo -e "${RED}ERROR: Local and remote main have diverged!${NC}"
            echo -e "${RED}Another agent may have pushed changes.${NC}"
            echo ""
            echo "To resolve:"
            echo "  1. git pull --rebase origin $MAIN_BRANCH"
            echo "  2. Resolve any conflicts"
            echo "  3. git push origin $MAIN_BRANCH"
            echo ""
            echo "Or use the safe-merge script next time:"
            echo "  ./scripts/safe-merge.sh <your-branch>"
            exit 1
        fi
    fi
fi

exit 0
