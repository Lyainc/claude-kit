name: Validate Templates

on:
  pull_request:
    paths:
      - 'template/**'
      - 'scripts/validate-templates.sh'
      - 'scripts/generate-manifest.sh'
  push:
    branches:
      - main
    paths:
      - 'template/**'

jobs:
  validate:
    name: Template Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate templates
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Running Template Validation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ./scripts/validate-templates.sh

      - name: Check manifest integrity
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Checking Manifest Integrity"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Generate manifest (modifies file in place)
          ./scripts/generate-manifest.sh > /dev/null 2>&1

          # Compare with committed manifest
          if ! git diff --exit-code template/.claude-kit-manifest.json; then
            echo ""
            echo "âŒ ERROR: Manifest is out of sync with template files"
            echo ""
            echo "The manifest hash does not match the current template files."
            echo "This usually means you modified templates but didn't regenerate the manifest."
            echo ""
            echo "To fix:"
            echo "  1. Run: ./scripts/generate-manifest.sh"
            echo "  2. Review changes: git diff template/.claude-kit-manifest.json"
            echo "  3. Commit the updated manifest"
            echo ""
            exit 1
          fi

          echo "âœ… Manifest integrity verified"

      - name: Validation summary
        if: success()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                  âœ… All Checks Passed!                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ“ Template validation: PASS"
          echo "âœ“ Manifest integrity: PASS"
          echo ""

      - name: Validation failed summary
        if: failure()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                  âŒ Validation Failed                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Please fix the errors above and try again."
          echo ""
          echo "Common fixes:"
          echo "  â€¢ Template errors: Check SKILL.md frontmatter (name, description)"
          echo "  â€¢ Manifest errors: Run ./scripts/generate-manifest.sh"
          echo "  â€¢ Version errors: Update version in manifest before regenerating"
          echo ""
          echo "For detailed guidance, see:"
          echo "  â€¢ CLAUDE.md - Version Management Workflow"
          echo "  â€¢ docs/VERSION_MANAGEMENT.md"
          echo ""
